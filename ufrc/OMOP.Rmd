```{r}

library(readr)
library(tidyverse)
library(stringr)

# notes: https://ohdsi.github.io/CommonDataModel/cdm60.html#VOCABULARY

#Read in data as separate data frames

concept <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_v2.0.txt", show_col_types = FALSE) 

# concept <- read_csv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_test.csv", show_col_types = FALSE) 

vocabulary <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/vocabulary_v2.0.txt", show_col_types = FALSE) 
concept_ancestor <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_ancestor_v2.0.txt", show_col_types = FALSE) %>% rename(concept_id=ancestor_concept_id)
  
#concept_synonym <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_synonym_v2.0.txt", show_col_types = FALSE) 
                           

```

```{r}

# created params.R script that contains code below. Run as source from R CLI. 

source("/blue/djlemas/share/data/Benchmark/OMOP/data_release/ufrc/utils/params.R")

# library(readr)
# library(tidyverse)
# library(stringr)
# 
# # data location: /blue/djlemas/share/data/Benchmark/OMOP/data_release/
# 
# # notes: https://ohdsi.github.io/CommonDataModel/cdm60.html#VOCABULARY
# 
# #Read in data as separate data frames
# 
# concept <- read_tsv(file="/blue/djlemas/share/data/Benchmark/OMOP/data_release/concept_v2.0.txt", show_col_types = FALSE)
# 
# # concept <- read_csv(file="/blue/djlemas/share/data/Benchmark/OMOP/data_release/concept_test.csv", show_col_types = FALSE)
# 
# vocabulary <- read_tsv(file="/blue/djlemas/share/data/Benchmark/OMOP/data_release/vocabulary_v2.0.txt", show_col_types = FALSE)
# concept_ancestor <- read_tsv(file="/blue/djlemas/share/data/Benchmark/OMOP/data_release/concept_ancestor_v2.0.txt", show_col_types = FALSE) %>% rename(concept_id=ancestor_concept_id)
# 
# concept_synonym <- read_tsv(file="/blue/djlemas/share/data/Benchmark/OMOP/data_release/concept_synonym_v2.0.txt", show_col_types = FALSE)
                           

```



```{r}

# Create Condition Concepts Dataset (condition_concept_df)

# Merge the Concept table with the Vocabulary table:  Primary key: concept_id 
                             
condition_concept_df_tm=full_join(concept,vocabulary,by='vocabulary_id') %>% 
  filter(concept_name != "No matching concept",
         domain_id == "Condition",
         standard_concept == "S",
         vocabulary_id == "SNOMED") 

# create CONCEPT_SOURCE_CODE
CONCEPT_SOURCE_CODE_tmp=condition_concept_df_tm %>%
  group_by(concept_id) %>%
  mutate(tmp_vocab_id = paste0(tolower(vocabulary_id),":",tolower(concept_code))) %>%
  distinct(tmp_vocab_id,.keep_all = TRUE) %>%
  # mutate(test=n_distinct(tmp_vocab_id)) %>%
  summarize(CONCEPT_SOURCE_CODE = str_c(tmp_vocab_id, collapse = "| ")) 
  
    # check
    # head(CONCEPT_SOURCE_CODE_tmp)
    # table(CONCEPT_SOURCE_CODE_tmp$test)
    # dim(CONCEPT_SOURCE_CODE_tmp)
    # dim(condition_concept_df_tm)

# create CONCEPT_SOURCE_LABEL
CONCEPT_SOURCE_LABEL_tmp=condition_concept_df_tm %>%
  group_by(concept_id) %>%
  distinct(concept_name,.keep_all = TRUE) %>%
  mutate(test=n_distinct(concept_name)) %>%
  summarize(CONCEPT_SOURCE_LABEL = str_c(concept_name, collapse = "| "))

    # check
    # head(CONCEPT_SOURCE_LABEL_tmp)
    # table(CONCEPT_SOURCE_LABEL_tmp$test)
    # dim(CONCEPT_SOURCE_LABEL_tmp)
    # dim(condition_concept_df_tm)

# create CONCEPT_VOCAB
CONCEPT_VOCAB_tmp=condition_concept_df_tm %>%
  group_by(concept_id) %>%
  distinct(vocabulary_id,.keep_all = TRUE) %>%
  mutate(test=n_distinct(vocabulary_id)) %>%
  summarize(CONCEPT_VOCAB = str_c(tolower(vocabulary_id), collapse = "| "))
         
    # check
    # head(CONCEPT_VOCAB_tmp)
    # table(CONCEPT_VOCAB_tmp$test)
    # dim(CONCEPT_VOCAB_tmp)
    # dim(condition_concept_df_tm)

# create CONCEPT_VOCAB_VERSION
CONCEPT_VOCAB_VERSION_tmp=condition_concept_df_tm %>%
  group_by(concept_id) %>%
  distinct(vocabulary_version,.keep_all = TRUE) %>%
  mutate(test=n_distinct(vocabulary_version)) %>%
  summarize(CONCEPT_VOCAB_VERSION = str_c((tolower(vocabulary_version)), collapse = "| ")) 

    # check
    # head(CONCEPT_VOCAB_VERSION_tmp)
    # table(CONCEPT_VOCAB_VERSION_tmp$test)
    # dim(CONCEPT_VOCAB_VERSION_tmp)
    # dim(condition_concept_df_tm)

%>%
  rename(STANDARD_CONCEPT=standard_concept,
         CONCEPT_ID=concept_id,
         CONCEPT_LABEL=concept_name) %>%
  select(CONCEPT_ID,CONCEPT_SOURCE_CODE,CONCEPT_LABEL,CONCEPT_SOURCE_LABEL,CONCEPT_VOCAB,CONCEPT_VOCAB_VERSION)

# 
# list the concept-ids from Conditions Concept Dataset
ccdf_concept_id=condition_concept_df$CONCEPT_ID

```




```{r}

# Create Condition Ancestors Dataset (condition_ancestor_df)

# Merge the Concept table with the ancestor table:  Primary key: concept_id 
                             
concept_ancestor_merged=full_join(concept,concept_ancestor,by='concept_id')

# Merge the above table with the vocabulary table:  Primary key: vocabulary_id 
                             
concept_ancestor_df_tmp=full_join(concept_ancestor_merged,vocabulary,by='vocabulary_id') %>%
  as_tibble() %>%
  filter(descendant_concept_id %in% ccdf_concept_id,
         concept_name != "No matching concept",
         domain_id == "Condition",
         !is.na(concept_id),
         !is.null(concept_id)) 

# create ANCESTOR_CONCEPT
ANCESTOR_CONCEPT_ID_tmp=concept_ancestor_df_tmp%>%
  group_by(descendant_concept_id) %>%
  summarize(ANCESTOR_CONCEPT_ID = str_c(concept_id, collapse = "| ")) 

# create ANCESTOR_SOURCE_CODE
ANCESTOR_SOURCE_CODE_tmp = concept_ancestor_df_tmp %>%
  group_by(descendant_concept_id) %>%
  mutate(ANCESTOR_SOURCE_CODE_tmp = paste0(tolower(vocabulary_id),":",tolower(concept_code))) %>%
  summarize(ANCESTOR_SOURCE_CODE = str_c(ANCESTOR_SOURCE_CODE_tmp, collapse = "| "))

# create ANCESTOR_VOCAB
ANCESTOR_VOCAB_tmp = concept_ancestor_df_tmp %>%
  group_by(descendant_concept_id) %>%
  distinct(vocabulary_id,.keep_all = TRUE) %>%
  summarize(ANCESTOR_VOCAB = str_c(vocabulary_id, collapse = "| ")) %>%
  mutate( ANCESTOR_VOCAB_tmp=str_count(ANCESTOR_VOCAB, pattern = "|")) %>%
  select(descendant_concept_id,ANCESTOR_VOCAB,ANCESTOR_VOCAB_tmp)

table(ANCESTOR_VOCAB_tmp$ANCESTOR_VOCAB_tmp)


df <- tibble(
  g = c(1, 1, 2, 2, 2),
  x = c(1, 1, 2, 1, 2),
  y = c(3, 2, 1, 3, 1)
)

df <- df %>% group_by(g)

df_1=df %>% distinct(x,.keep_all = TRUE)

test=distinct(df, x, .keep_all = TRUE)




head(ANCESTOR_VOCAB_tmp)
dim(concept_ancestor_df_tmp)
dim(ANCESTOR_VOCAB_tmp)

unique(concept_ancestor_df_tmp$vocabulary_id)


length(intersect(concept_ancestor_df$descendant_concept_id,ccdf_concept_id))

dim(concept_ancestor_df)
str(concept_ancestor_df)
which(concept_ancestor_df$concept_name=="No matching concept")
table(concept_ancestor_df$ANCESTOR_CONCEPT_ID_tmp)

length(concept_ancestor_df$concept_id)               # 80375173
length(unique(concept_ancestor_df$concept_id))       # 6628707

length(concept_ancestor_df$descendant_concept_id)    # 80375173 
length(unique(concept_ancestor_df$descendant_concept_id))  # 3810042

concept_ancestor_df$
  names(concept_ancestor_df)
head(concept_ancestor_df)

  
  test_df=concept_ancestor_df


# output from UFRC
save(test_df, file = "concept_ancestor_test.RData")
  
load(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_ancestor_test.RData")

```
