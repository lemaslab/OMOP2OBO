```{r}

library(readr)
library(tidyverse)
library(stringr)

# notes: https://ohdsi.github.io/CommonDataModel/cdm60.html#VOCABULARY

#Read in data as separate data frames

concept <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_v2.0.txt", show_col_types = FALSE) 

# concept <- read_csv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_test.csv", show_col_types = FALSE) 

vocabulary <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/vocabulary_v2.0.txt", show_col_types = FALSE) 
concept_ancestor <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_ancestor_v2.0.txt", show_col_types = FALSE) %>% rename(concept_id=ancestor_concept_id)
  
#concept_synonym <- read_tsv(file="V:/FACULTY/DJLEMAS/BENCHMARK_DATA/OMOP2OBO/cancer/data_release/concept_synonym_v2.0.txt", show_col_types = FALSE) 
                           

```


```{r}

# Create Condition Concepts Dataset

# Merge the Concept table with the Vocabulary table:  Primary key: concept_id 
                             
concept_vocab_filter=full_join(concept,vocabulary,by='vocabulary_id') %>% 
  filter(concept_name != "No matching concept") %>%
  filter(domain_id == "Condition") %>%
  filter(standard_concept == "S") %>%
  filter(vocabulary_id == "SNOMED") %>%
  mutate(tolower_vocab_id_tmp <- paste0(tolower(vocabulary_id),":",tolower(concept_code))) %>%
  rename(tmp_vocab_id="tolower_vocab_id_tmp <- paste0(tolower(vocabulary_id), \":\", tolower(concept_code))") %>%
  group_by(concept_id) %>%
  mutate(CONCEPT_SOURCE_CODE = str_c(tmp_vocab_id, collapse = " | ")) %>%
  mutate(CONCEPT_SOURCE_LABEL = str_c(concept_name, collapse = " | ")) %>%
  mutate(CONCEPT_VOCAB = str_c(tolower(vocabulary_id), collapse = " | ")) %>%
  mutate(CONCEPT_VOCAB_VERSION = str_c(tolower(vocabulary_version), collapse = " | ")) %>%
  rename(STANDARD_CONCEPT=standard_concept,
         CONCEPT_ID=concept_id,
         CONCEPT_LABEL=concept_name) %>%
  select(CONCEPT_ID,CONCEPT_SOURCE_CODE,CONCEPT_LABEL,CONCEPT_SOURCE_LABEL,CONCEPT_VOCAB,CONCEPT_VOCAB_VERSION)

# list the concept-ids from Conditions Concept Dataset
concept_id=concept_vocab_filter$CONCEPT_ID

```




```{r}

# Create Condition Ancestors Dataset

# Merge the Concept table with the ancestor table:  Primary key: concept_id 
                             
concept_ancestor_merged=full_join(concept,concept_ancestor,by='concept_id')

# Merge the above table with the vocabulary table:  Primary key: vocabulary_id 
                             
concept_ancestor_vocab_merged=full_join(concept_ancestor_merged,vocabulary,by='vocabulary_id') %>%
  filter(descendant_concept_id %in% concept_id) %>%
  filter(concept_name != "No matching concept") %>%
  filter(domain_id == "Condition") %>%
  filter(concept_id != NULL)

rm(concept_ancestor_merged,concept_vocab_filter)
rm(concept,concept_ancestor)
rm(concept_ancestor_vocab_merged_trim)





```
